name: compile
on:
  workflow_call

jobs:
  compile:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    strategy:
      matrix:
        os: [linux, windows]

    steps:
    - uses: actions/checkout@v4

    - name: Cache CMake build (Linux)
      if: matrix.os == 'linux'
      uses: actions/cache@v3
      with:
        path: |
          build/
        key: cmake-build-linux-${{ runner.os }}-${{ hashFiles('dependencies.cmake')}}
        restore-keys: |
          cmake-build-linux-${{ runner.os }}-

    - uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: flex bison javacc libflac-dev libx11-dev libxext-dev libgl1-mesa-dev libudev-dev libopenal-dev libvorbis-dev libxcursor-dev libxrandr-dev libfreetype6-dev libjpeg-dev libudev-dev libxinerama-dev libxi-dev libxrandr-dev libxss-dev libglu1-mesa-dev libgl1-mesa-dev libpulse-dev libasound2-dev libssl-dev libx11-xcb-dev libxcb1-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev libxcb-randr0-dev libxcb-render-util0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev libxcb-xinerama0-dev libxcb-xkb-dev libxcb-xrm-dev libxcb-xtest0-dev libxcb-xv0-dev libxcb-xvmc0-dev libxcb-xv
    
    - name: Check compilation (Linux)
      if: matrix.os == 'linux'
      run: |
        echo "## 🚀 Linux compilation result" >> $GITHUB_STEP_SUMMARY
        mkdir -p build
        cd build
        {
          set +e
          cmake ..; make
          if [ $? -ne 0 ]; then
            echo "- ### Compilation failed ❌" >> $GITHUB_STEP_SUMMARY
            echo "Linux compilation failed."
            exit 1
          else
            echo "- ### Compilation succeed ✅" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
        }

    - name: Cache Mingw-w64 (Windows)
      if: matrix.os == 'windows'
      uses: actions/cache@v3
      with:
        path: /usr/lib/mingw-w64
        key: mingw-w64-${{ runner.os }}

    - name: Install Mingw-w64 (Windows)
      if: matrix.os == 'windows'
      run: sudo apt-get install -y mingw-w64 mingw-w64-tools mingw-w64-x86-64-dev

    - name: Cache cross-compilation artifacts (Windows)
      if: matrix.os == 'windows'
      uses: actions/cache@v3
      with:
        path: build-mingw32
        key: cross-build-windows-${{ runner.os }}-${{ hashFiles('tools/build-mingw32.sh', 'cmake/mingw32-toolchain.cmake', 'dependencies.cmake' ) }}
        restore-keys: |
          cross-build-windows-${{ runner.os }}-


    - name: Cross-compile for Windows
      if: matrix.os == 'windows'
      run: |
        echo "## 🚀 Cross-compilation for Windows result" >> $GITHUB_STEP_SUMMARY
        chmod +x tools/build-mingw32.sh
        {
          set +e
          ./tools/build-mingw32.sh
          if [ $? -ne 0 ]; then
            echo "- ### Cross-compilation for Windows failed ❌" >> $GITHUB_STEP_SUMMARY
            echo "Cross-compilation failed."
            exit 1
          else
            echo "- ### Cross-compilation succeed ✅" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
        }
